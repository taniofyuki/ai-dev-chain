# 整合性チェック設計

本章では、成果物の品質を担保するための整合性チェックを定義する。  
整合性チェックは **AI により自動実行**され、レビュー開始前の品質ゲートとして機能する。

---

## 1. チェック対象（品質ルール）

### 1.1 参照整合性
- report からリンクされている spec / src / config のファイル存在確認
- リンク切れの検出

### 1.2 用語整合性
- 用語集と本文の一致
- 表記揺れ・未定義語の検出

### 1.3 要求 ↔ 設計 対応関係
- requirements の各要求が設計に反映されていること
- 未対応要求の検出

### 1.4 未決事項検出
- 文書中の TBD / FIXME / 未定 の残存チェック

### 1.5 差分一貫性
- report の変更内容が spec に反映されていること

---

## 2. AIによる自動チェック

### 2.1 実行タイミング
- 整合性チェックは **レビュー開始前（PR作成直前）に1回のみ** 自動実行する

### 2.2 入力
AIは以下を入力としてチェックを行う。

- 当該フェーズで更新対象となった成果物一式  
  - `/docs/spec` 配下（変更対象ファイル）
  - `/docs/reports/<phase>.md`（当該フェーズのレポート）
  - 必要に応じて `/src`, `/config` の変更対象
- リポジトリのファイル一覧（リンク存在確認に利用）
- 変更差分（差分一貫性の検証に利用）

### 2.3 出力（チェック結果）
AIはチェック結果を以下の形式で出力する。

- 判定区分（BLOCK / WARN / INFO）
- 指摘事項一覧
  - 対象ファイル
  - 位置（見出し、行、アンカーなど可能な範囲）
  - 理由
  - 修正方針
- 可能な場合は修正パッチ（修正案）

チェック結果は必ず当該フェーズの report に記録する。

---

## 3. 自動修正ループ

### 3.1 基本方針
- **BLOCK が存在する場合、PRは作成しない**
- AIは BLOCK を解消するために自動修正を試みる
- 自動修正後、同一フェーズ内で再度チェックを行う

### 3.2 リトライ上限
- 自動修正と再チェックの繰り返しは、フェーズあたり **最大3回** とする
- 上限到達後も BLOCK が解消できない場合、フェーズ状態を Blocked とし、人の判断を求める

### 3.3 人へのエスカレーション
Blocked となった場合、report に以下を明記する。

- 解消できなかった BLOCK の一覧
- 試行した修正内容の要約
- 次に取るべき手順（手動修正の提案）

---

## 4. チェックタイミングと制御

- チェックはレビュー開始前に1回のみ実施（ただし BLOCK 解消のための再チェックは許容）
- BLOCK が1件でもあれば PR を作成せずフェーズを停止
- WARN / INFO のみの場合は PR を作成しレビューへ進む
- 承認は人の判断のみとする

---

## 5. 合格ライン（判定区分）

| 区分 | 意味 |
|----|----|
| BLOCK | フェーズ進行を止める |
| WARN | 進行は止めないが要対応 |
| INFO | 参考情報 |

### 5.1 判定基準

#### 参照整合性
- BLOCK：リンク切れが存在する
- WARN：構造が不自然なリンク
- INFO：整理改善の提案

#### 用語整合性
- BLOCK：必須用語が未定義
- WARN：表記揺れが多い
- INFO：推奨表記提案

#### 要求 ↔ 設計
- BLOCK：未対応要求が存在
- WARN：対応関係の記載不足
- INFO：追跡改善提案

#### 未決事項
- BLOCK：spec に未決事項が残る
- WARN：report にのみ未決事項が残る
- INFO：将来検討項目として妥当

#### 差分一貫性
- BLOCK：report の変更が spec に未反映
- WARN：report の記載不足
- INFO：要約改善提案


