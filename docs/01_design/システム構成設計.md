# システム構成設計

本章では、AI開発自動化システムを構成する主要コンポーネント、コンポーネント間インタフェース、外部インタフェース、データ配置、および代表的な実行フローを定義する。

---

## 1. コンポーネント構成

### 1.1 コンポーネント一覧
本システムは以下のコンポーネントで構成する。

1. **Orchestrator（実行制御）**  
   フェーズ開始から終了までの制御（ロール呼び出し順、判定、停止、通知など）を担う。

2. **Role Runners（ロール実行）**  
   Planner / Doc Writer / Code Writer / Reviewer / Checker など各ロールのAI実行を担当し、作業パケット（packet）を更新する。

3. **Workspace Manager（作業領域管理）**  
   Git操作（作業ブランチ作成、差分取得など）およびファイルI/Oを担う。

4. **GitHub Adapter（GitHub連携）**  
   PR作成、コメント、マージ（自動マージON時）を行う。GitHub API操作は本コンポーネントに集約する。

5. **Doc/Artifact Manager（成果物管理）**  
   成果物の構造（docs/src/config）・命名規約・テンプレ選択（default/overrides）・report配置・リンク整備・整形を担う。  
   ※ reportの文章生成そのものはAI（Doc Writer）が担い、本コンポーネントは構造面の適用・整形を担う。

6. **Notification（通知）**  
   `WorkflowBlocked` 等の通知イベントを発行し、配送先へ配信する。配送先は後続レイヤで差し替え可能にする。

---

## 2. 責務境界（誰が何を持つか）

責務が曖昧だと実装が複雑化するため、以下の境界で分離する。

- **Orchestrator**：状態遷移と順序制御のみ（制御の中心）
- **Role Runners**：AI呼び出しとパケット更新
- **Workspace Manager**：Git操作・差分取得・ファイルI/O
- **Doc/Artifact Manager**：成果物構造の適用・テンプレ選択・report配置とリンク整備・整形
- **GitHub Adapter**：GitHub API操作
- **Notification**：通知イベント生成と配送

---

## 3. コンポーネント間インタフェース

### 3.1 基本方針
- Orchestrator が中心となり、各コンポーネントを呼び出す
- コンポーネント間の情報受け渡しの中心は作業パケット（packet）とする

### 3.2 主要インタフェース一覧

| 呼び出し元 → 呼び出し先 | 入力 | 出力 |
|------------------|------|------|
| Orchestrator → Role Runners | packet | 更新済み packet |
| Orchestrator → Workspace Manager | 作業指示（ブランチ/差分対象等） | 差分、ファイル一覧 |
| Orchestrator → Doc/Artifact Manager | 期待構造、テンプレ選択条件、生成物 | report配置・リンク整備結果 |
| Orchestrator → GitHub Adapter | PR情報（タイトル/本文/差分） | PR URL |
| Orchestrator → Notification | 通知イベント | 配送結果 |

---

## 4. 外部インタフェース（API / UI）

### 4.1 操作手段
- **CLI**：初期実装の中心。フェーズ開始、状態確認、再実行などの操作を提供する。
- **管理画面**：後続フェーズで設計。状態可視化、履歴確認、Blocked確認などを提供する。

### 4.2 初期CLIで提供する操作（概念）
- `start <phase>`：指定フェーズの実行開始
- `status`：実行中/停止中/レビュー待ちなど状態表示
- `rerun <phase>`：同フェーズを再実行（差戻し対応）
- `show report <phase>`：reportへの参照（パス/リンク）

（コマンド名は例であり、詳細は後続で確定する）

---

## 5. データ構成（保存先と責務）

### 5.1 保存場所一覧

| 種類 | 保存場所 | 内容 |
|-----|-----|-----|
| 成果物 | `/docs`, `/src`, `/config` | 仕様書・コード・設定 |
| 作業データ | `/.workflow` | packet, logs |
| レビュー履歴 | GitHub | PR / コメント |
| ユーザー設定 | `~/.ai-dev/config.yaml` | CLI設定（将来拡張） |

### 5.2 主要な考え方
- 成果物はリポジトリに残し、Gitで履歴管理する
- 作業データ（packet/log）は作業用であり、Gitにはコミットしない
- PR/コメントはレビュー履歴としてGitHubに残す
- 設定はユーザー環境またはプロジェクト設定に分離（後続レイヤで設計）

---

## 6. 代表的な実行フロー（シーケンス）

### 6.1 フロー全体
以下は、フェーズ開始からPR作成またはBlocked停止に至る代表的な流れである。

```
User (CLI)
  ↓ start phase
Orchestrator
  ↓
Workspace Manager
  - 作業ブランチ作成
  - 直前差分取得
  - 作業領域準備
  ↓
Role Runners (Planner)
  - 計画生成（target_files / tasks / open_questions）
  ↓
Doc/Artifact Manager
  - テンプレ選択（overrides優先）
  - docs構造適用（配置ルールの前提を整える）
  ↓
Role Runners (Doc Writer / Code Writer)
  - 成果物生成（spec / src / config）
  - report本文生成（文章はAIが作る）
  ↓
Doc/Artifact Manager
  - report配置
  - 参照リンク整備
  - 構成整形（章立て・一覧整形等）
  ↓
Role Runners (Reviewer: optional)
  - 多角的レビュー（WARN/INFO）
  ↓
Role Runners (Checker)
  - 整合性チェック（BLOCK/WARN/INFO）
  ↓
Orchestrator（判定）
  ├─ WARN/INFOのみ
  │    ↓
  │  GitHub Adapter
  │    - PR作成（タイトル/本文テンプレ適用）
  │    ↓
  │  状態：NeedsReview
  └─ BLOCKあり
       ↓
     自動修正ループ（最大3回）
       - Writer（BLOCK原因箇所のみ修正）
       - Doc/Artifact Manager（report更新・整形）
       - Checker（再チェック）
       ↓
     解消不可 → Notification（WorkflowBlocked）→ 状態：Blocked
```

### 6.2 Doc/Artifact Manager の位置づけ
- report本文はAIが生成する  
- Doc/Artifact Managerは構造・配置・リンク・整形を担い、ドキュメントがルールに沿う状態を保証する

### 6.3 Blocked通知
- PRを作成しないため、Blocked時は Notification により別経路で通知する  
- reportには必ず「BLOCK一覧」「試行内容」「人が行うべき手順」を記載する


